<!doctype html>
<html>
<head>
    <style type="text/css">
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
    <script>
        var draw = function() {
            (function() {
                var lastTime = 0;
                var vendors = ['ms', 'moz', 'webkit', 'o'];
                for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
                    window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
                            || window[vendors[x]+'CancelRequestAnimationFrame'];
                }

                if (!window.requestAnimationFrame)
                    window.requestAnimationFrame = function(callback, element) {
                        var currTime = new Date().getTime();
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                        var id = window.setTimeout(function() { callback(currTime + timeToCall); },
                                timeToCall);
                        lastTime = currTime + timeToCall;
                        return id;
                    };

                if (!window.cancelAnimationFrame)
                    window.cancelAnimationFrame = function(id) {
                        clearTimeout(id);
                    };
            }());

            var render = function() {
                var canvas = document.getElementById('canvas');
                canvas.width = document.body.clientWidth;
                canvas.height = document.body.clientHeight;

                this.canvasWidth  = canvas.width;
                this.canvasHeight = canvas.height;
                this.ctx = canvas.getContext('2d');
                this._player = {};
                this._map = {};
            };
            render.prototype = {
                render: function() {
                    var size = 32, margin = 2, id = ['white', 'gray', 'black'];
                    this.ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
                    var pS = size * 0.5;

                    for (var x in this._map.matrix) {
                        for (var y in this._map.matrix[x]) {
                            if (id[this._map.matrix[x][y]]) {
                                this.ctx.fillStyle = id[this._map.matrix[x][y]];
                            } else {
                                if (this._map.matrix[x][y] > 10) {
                                    this.ctx.fillStyle = 'rgb(0, ' + Math.round(255 * (this._map.matrix[x][y] / 40)) + ', 0)';
                                } else {
                                    this.ctx.fillStyle = 'rgb(' + Math.round(255 * (this._map.matrix[x][y] / 10)) + ', 0, 0)';
                                }
                            }
                            this.ctx.fillRect(x * (size + margin), y * (size + margin), size, size);
                        }
                    }

                    id = ['red', 'blue', 'green', 'yellow'];
                    for (var i in this._player) {
                        this.ctx.fillStyle = (this._player[i].dead) ? 'gray' : id[i];
                        this.ctx.fillRect((this._player[i].x * (size + margin)) + (pS / 2), (this._player[i].y * (size + margin)) + (pS / 2), pS, pS);
                    }

                    this.ctx.fillStyle = 'white';
                    for (var x in this._map.matrix) {
                        for (var y in this._map.matrix[x]) {
                            this.ctx.fillText(this._map.matrix[x][y], (x * (size + margin)) + (pS / 2), (y * (size + margin)) + pS);
                        }
                    }

                    return (this);
                },
                update: function(data) {
                    data = JSON.parse(data);
                    if (data.action == 'player') {
                        this._player = data.data;
                    }
                    if (data.action == 'map') {
                        this._map = data.data;
                    }
                }
            };

            var core = new render();
            var update = function() {
                core.render();
                window.requestAnimationFrame(update);
            };
            update();

            var ws = new WebSocket('ws://' + window.location.hostname + ':8080');
            //ws.binaryType = 'arraybuffer';

            ws.onopen = function(event) {
                ws.onmessage = function(evt) {
                    core.update(evt.data);
                };
                ws.send('map');
                ws.send('player');

                var button = {
                    38: 'up',
                    40: 'down',
                    37: 'left',
                    39: 'right',
                    32: 'bomb'
                };
                document.addEventListener('keyup', function(event) {
                    ws.send(button[event.keyCode]);
                });
                /*var ping = function() {
                    ws.send('ping');
                    setTimeout(function() {
                        ping();
                    }, 300);
                };
                ping();*/
            }
        };
    </script>
</head>
<body onload="draw()">
<canvas id="canvas" style="width:100%;height:100%"></canvas>
</body>
</html>